# Docker实验环境部署记录 - 2025年10月14日

## 📋 实验概览
- **日期**: 2025年10月14日
- **项目**: Docker容器化实验环境
- **状态**: ✅ 部署完成
- **架构原则**: MVP (最小可行产品) - 简化配置，优先可用性

## 🏗️ 系统架构设计

### 网络架构 (MVP原则)
- **网络模式**: Docker默认bridge网络 (172.17.0.0/16)
- **设计理念**: 避免复杂的自定义网络配置
- **容器通信**: 通过内网IP地址直接访问

### 域名规划
```
# Windows hosts文件配置 (C:\Windows\System32\drivers\etc\hosts)
192.168.14.201  huaqloud.local
192.168.14.201  portal.huaqloud.local      # Portainer管理界面
192.168.14.201  monitor.huaqloud.local     # Beszel监控界面
192.168.14.201  npm.huaqloud.local         # Nginx Proxy Manager
192.168.14.201  game.huaqloud.local        # 2048游戏演示
```

## � Docker环境基础

### 系统信息
- **操作系统**: Ubuntu 20.04.6 LTS
- **Docker版本**: 26.1.3
- **CPU**: 4核 Intel处理器
- **内存**: 7.8GB RAM
- **网络**: 124+ Mbps带宽，延迟良好

### 防火墙配置
```bash
# 系统防火墙已配置允许必要端口
ufw allow 9000/tcp    # Portainer
ufw allow 8090/tcp    # Beszel
ufw allow 80/tcp      # NPM HTTP
ufw allow 443/tcp     # NPM HTTPS
ufw allow 81/tcp      # NPM管理
ufw allow 2048/tcp    # 游戏演示
```

## � Portainer Docker管理平台部署

### 部署时间
- 执行时间: 2025-10-14 下午

### 安装过程
1. **环境准备**
   - Docker服务状态: ✅ 正常 (版本 26.1.3)
   - 当前运行容器: 0个

2. **存储配置**
   ```bash
   docker volume create portainer_data
   ```
   - 数据卷创建: ✅ 成功

3. **容器部署** (优化版)
   ```bash
   # 简化配置，仅使用HTTP 9000端口
   docker run -d -p 9000:9000 --name portainer \
     --restart=always \
     -v /var/run/docker.sock:/var/run/docker.sock \
     -v portainer_data:/data \
     portainer/portainer-ce:latest
   ```

### 部署结果
- **容器状态**: ✅ 运行中
- **端口映射**: 9000 → 9000 (仅HTTP)
- **数据持久化**: ✅ 已配置
- **Docker Socket**: ✅ 已挂载
- **配置原则**: MVP实验环境，简化配置

### 访问信息
- **服务器IP**: 192.168.14.201
- **HTTP访问**: http://192.168.14.201:9000 ✅
- **连通性测试**: HTTP 200 OK
- **初始设置**: 首次访问需创建管理员账户

### 优化说明
- 🎯 **MVP原则**: 实验环境优先简化配置
- 🔧 **单端口**: 仅使用9000端口，便于管理
- 🚀 **性能**: HTTP协议，减少SSL开销
- 📦 **端口规划**: 为后续容器实验预留端口空间

### Portainer功能特性
- 🖥️ Web图形化界面管理Docker
- 📊 容器/镜像/网络/卷的可视化管理
- 📈 资源监控和日志查看
- 🔧 容器编排和模板支持
- 👥 多用户权限管理
- 🔄 自动重启策略

## � Beszel容器监控平台部署

### 部署时间
- 执行时间: 2025-10-14 下午

### 项目选择
选择 **Beszel** 作为监控解决方案：
- **项目地址**: https://github.com/henrygd/beszel
- **Stars**: 15.7k+ (活跃项目)
- **特点**: 轻量级、专为容器设计、现代化界面

### 部署流程（正确版本）

#### 第一步：按官方默认配置部署Hub
1. **清理环境**
   ```bash
   # 清理所有旧配置和容器
   docker stop beszel-hub beszel-agent
   docker rm beszel-hub beszel-agent
   docker volume rm beszel_data
   docker rmi henrygd/beszel henrygd/beszel-agent
   ```

2. **创建官方docker-compose.yml**
   ```yaml
   version: '3.3'
   
   services:
     beszel:
       image: henrygd/beszel
       container_name: beszel
       restart: unless-stopped
       ports:
         - 8090:8090
       volumes:
         - ./beszel_data:/beszel_data
   ```

3. **启动Hub**
   ```bash
   docker-compose up -d
   ```

#### 第二步：通过Web界面配置Agent
1. **访问Hub界面**: http://192.168.14.201:8090
2. **创建管理员账户**（首次访问自动提示）
3. **添加系统**: 点击"Add System"按钮
4. **获取Agent配置**: 界面自动生成完整的Agent部署命令

#### 第三步：使用官方生成的配置部署Agent
```bash
docker run -d --name beszel-agent --network host --restart unless-stopped \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  -v ./beszel_agent_data:/var/lib/beszel-agent \
  -e KEY="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIofTsQda5uRj+CvnlhDc0Igb7zfOUwvh/deoyFwiY8k" \
  -e LISTEN=45876 \
  -e TOKEN="129f-be60fbe566-1dd7-e519bc7109" \
  -e HUB_URL="http://192.168.14.201:8090" \
  henrygd/beszel-agent
```

### 部署结果
- **Hub状态**: ✅ 运行正常
- **Agent状态**: ✅ WebSocket连接成功
- **数据收集**: ✅ 系统和容器指标正常收集
- **连接方式**: WebSocket (SSH服务已自动停止)

### 关键配置说明
- **网络模式**: `--network host` (必需，用于获取主机网络统计)
- **KEY**: SSH公钥（由Hub生成）
- **TOKEN**: Universal Token（由Hub生成）
- **HUB_URL**: Hub的访问地址
- **数据持久化**: Hub和Agent数据都已配置持久化

### 访问信息
- **监控界面**: http://192.168.14.201:8090
- **Agent端口**: 45876 (内部使用)
- **连接状态**: ✅ WebSocket连接正常

### 监控功能确认
- 🖥️ **系统监控**: CPU、内存、磁盘、网络 - ✅ 正常
- 🐳 **容器监控**: Docker容器详细统计 - ✅ 正常
- 📊 **可视化**: 现代化Web界面 - ✅ 可访问
- 📈 **历史数据**: 性能趋势分析 - ✅ 开始收集
- 🔔 **告警系统**: 可配置监控阈值 - ✅ 可配置

### 经验教训
1. **严格按官方文档**: 避免自定义配置导致的问题
2. **Web界面配置**: 使用Hub生成的标准配置最可靠
3. **Universal Token**: 0.12.0+版本的推荐连接方式
4. **Host网络**: Agent必须使用host网络模式获取完整统计

##  下一步计划
- [x] Docker环境测试 - ✅ 完成
- [x] Portainer图形管理界面 - ✅ 部署完成  
- [x] Beszel监控平台 - ✅ 部署成功并正常运行
- [x] Beszel Agent配置 - ✅ WebSocket连接成功
- [x] 网络架构优化 - ✅ 迁移到MVP简化方案
- [x] NPM反向代理部署 - ✅ 基础部署完成
- [x] 演示应用部署 - ✅ 2048游戏正常运行
- [ ] NPM反向代理配置 - 🚧 准备配置域名访问
- [ ] SSL证书管理测试
- [ ] 监控数据分析和告警配置
- [ ] 更多容器化应用部署实验

## 🎯 今日实验总结

### 成功部署的服务
1. **Portainer** (172.17.0.2:9000) - 容器管理界面 ✅
2. **Beszel Hub** (172.17.0.4:8090) - 监控中心 ✅
3. **Beszel Agent** - 系统监控代理 ✅
4. **NPM** (172.17.0.5:80/443/81) - 反向代理 ✅
5. **2048游戏** (172.17.0.3:80) - 演示应用 ✅

### 架构优化成果
- **网络简化**: 从复杂自定义网络迁移到默认bridge网络
- **MVP实践**: 遵循最小可行产品原则，优先简单可用
- **配置标准化**: 统一使用docker run命令部署，避免compose复杂性
- **故障排除**: 成功解决网络隔离导致的容器通信问题

### 域名访问配置
```
# Windows hosts配置 (已完成)
192.168.14.201  huaqloud.local
192.168.14.201  portal.huaqloud.local      # Portainer
192.168.14.201  monitor.huaqloud.local     # Beszel
192.168.14.201  npm.huaqloud.local         # NPM管理
192.168.14.201  game.huaqloud.local        # 2048游戏
```

### 关键成果
1. ✅ **完整的容器管理环境** - Portainer提供图形化管理
2. ✅ **实时监控体系** - Beszel监控系统和容器性能
3. ✅ **反向代理基础设施** - NPM准备提供统一域名访问
4. ✅ **演示应用环境** - 2048游戏作为测试目标
5. ✅ **MVP架构实践** - 简化网络配置，提高可维护性

**完整的部署指南已保存至**: `/root/copilot-docker-experiments/docs/docker-lab-deployment-guide.md`

## 📊 数据记录
```
DNS解析: 0.547s
Ping延迟: 33.5ms (avg)
下载速度: 124.45 Mbps
上传速度: 106.17 Mbps
丢包率: 0%
```

---
*最后更新: 2025-10-14*